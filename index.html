<!doctype>
<html>
<head>
	<title>Organisational Chart</title>
	<link rel="stylesheet" href="style.css">
</head>
<body>
<div id="map"></div>
<script src="jquery.min.js"></script>
<script src="chart.js"></script>
<script src="jquery.tmpl.js"></script>
<script src="jquery.scrollto.js"></script>
<script src="raphael.js"></script>
<script>

function draw_line(paper, start_position, end_position) {
	// Try to straighten the lines

	if (start_position.left == end_position.left) {
		// Easy
		var c = paper.path("M" + start_position.left + " " + start_position.top + "L" + end_position.left + " " + end_position.top);
	} else {
		var middle_top = start_position.top + ((end_position.top - start_position.top)/2);
		var c = paper.path("M" + start_position.left + " " + start_position.top + "L" + start_position.left + " " + middle_top + "L" + end_position.left + " " +middle_top + "L" + end_position.left + " " + end_position.top);
	}
}

var paper = Raphael(0, 0, 10000, 10000);

function draw_lines(el) {
	var drawing = false;
	if ('node' in el['_meta']) {
		drawing = true;
	} else {
		paper.clear();
	}

	if (drawing) {
		var inner_node = el['_meta']['node'].find('.inner-node');
		var start_position = inner_node.offset();
		start_position.left += (inner_node.width()/2);
		start_position.top += inner_node.height();
	}

	for(var i in el) {
		if (i != '_meta') {
			if (drawing && el[i]['_meta']['node'].is(':visible')) {
				inner_node = el[i]['_meta']['node'].find('.inner-node');
				var end_position = inner_node.offset();
				end_position.left += inner_node.width()/2;
				draw_line(paper, start_position, end_position);
			}
			draw_lines(el[i]);
		}
	}
}

function calculate_width(el, caption) {
	var width = 0;

	if (!('_meta' in el) || !('hidden' in el['_meta']) || !(el['_meta']['hidden'])) {
		for(var i in el) {
			if (i != '_meta') {
				width += calculate_width(el[i], i);
			}
		}
	}

	if (width < 210) {
		width = 210;
	}
	if (!('_meta' in el)) {
		el['_meta'] = {};
	}

	el['_meta']['width'] = width;
	return width;
}

/**
 * Actually calculates the position of its children
 */
function calculate_positions(el, level) {
	if (!level) {
		level = 0;
	}

	var left = el['_meta']['left'];

	for(var i in el) {
		if (i != '_meta') {
			el[i]['_meta']['left'] = left;
			el[i]['_meta']['level'] = level;
			left += el[i]['_meta']['width'];
			calculate_positions(el[i], level + 1);
		}
	}
}

function count(obj) {
	c = 0;
	for (i in obj) {
		if (obj.hasOwnProperty(i)) {
			c++;
		}
	}
	return c;
}

var node_count = 0;
var BASE_LEVEL = 80;
var LEVEL_HEIGHT = 80;

function place_nodes(el, name) {
	node_count += 1;
	if (name) {
		var node;
		if (count(el) > 1) { 
			node = $('#nodeTemplateChildren').tmpl({"name": name}).css({"left": el['_meta']['left'], "width": el['_meta']['width'], "top": BASE_LEVEL + el['_meta']['level'] * LEVEL_HEIGHT}).appendTo($('body'));
		} else {
			node = $('#nodeTemplate').tmpl({"name": name}).css({"left": el['_meta']['left'], "width": el['_meta']['width'], "top": BASE_LEVEL + el['_meta']['level'] * LEVEL_HEIGHT}).appendTo($('body'));
		}
		node.data('node', el);
		el['_meta']['node'] = node;
	}
	for(var i in el) {
		if (i != '_meta') {
			place_nodes(el[i], i);
		}
	}
}

function position_nodes(el, name, callback) {
	if (name) {
		var node = el['_meta']['node'];
		node.animate({"left": el['_meta']['left'], "width": el['_meta']['width'], "top": BASE_LEVEL + el['_meta']['level'] * LEVEL_HEIGHT}, {"complete": callback});
	}
	for(var i in el) {
		if (i != '_meta') {
			position_nodes(el[i], i, callback);
		}
	}
}

function refresh_visibility(node, hidden_in_tree) {
	if ('_meta' in node && 'node' in node['_meta']) {
		if (hidden_in_tree) {
			node['_meta']['node'].hide();
		} else {
			node['_meta']['node'].show();
		}

		if (node['_meta']['hidden']) {
			node['_meta']['node'].find('.expand').text('v');
			hidden_in_tree = true;
		} else {
			node['_meta']['node'].find('.expand').text('^');
		}
	}

	for (var i in node) {
		if (i != '_meta') {
			refresh_visibility(node[i], hidden_in_tree);
		}
	}
}

$(function() {
	$.get('layout.txt', function(data) {
		var formatted_data = load_indented_data(data);

		calculate_width(formatted_data);

		formatted_data['_meta']['left'] = 0;
		calculate_positions(formatted_data);

		place_nodes(formatted_data);
		draw_lines(formatted_data);

		$('.node .inner-node .expand').click(function() {
			var node_el = $(this).closest('.node');
			var node = node_el.data('node');
			if (node['_meta']['hidden']) {
				// Show children
				delete(node['_meta']['hidden']);
			} else {
				// Hide children
				node['_meta']['hidden'] = true;
			}

			refresh_visibility(formatted_data);
			calculate_width(formatted_data);
			calculate_positions(formatted_data);
			paper.clear();

			var node_callbacks = 0;

			position_nodes(formatted_data, false, function() {
				node_callbacks += 1;
				if (node_callbacks == node_count - 1) {
					// Finished
					draw_lines(formatted_data);

					var node_position = node_el.offset();

					node_position.left -= ($(window).width()/2);
					node_position.top -= ($(window).height()/2);

					if (node_position.left < 0) {
						node_position.left = 0;
					}
					if (node_position.top < 0) {
						node_position.top = 0;
					}

					$.scrollTo(node_el.find('.inner-node'), 400, {offset:{top: (0-($(window).height()/2)), left: (0-($(window).width()/2))}});
				}
			});
		})
	});
})
</script>

<script id="nodeTemplateChildren" type="text/x-jquery-tmpl">
	<div class="node">
		<div class="inner-node">
			<span>${name}</span>
			<div class="expand">^</div>
		</div>
	</div>
</script>

<script id="nodeTemplate" type="text/x-jquery-tmpl">
	<div class="node">
		<div class="inner-node">
			<span>${name}</span>
		</div>
	</div>
</script>

</body>
</html>